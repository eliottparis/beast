#
# Copyright (c) 2013-2017 Vinnie Falco (vinnie dot falco at gmail dot com)
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
#

project beast/doc ;

import os ;
import path ;
import boostbook ;
import quickbook ;

#-------------------------------------------------------------------------------
#
# Build the list of header files that Doxygen will scan. We need
# this list to inform the build system of the dependencies so the
# docs can be rebuild if any of the header files change.
#

local sources = [ path.glob-tree ../include/boost/beast : *.hpp *.ipp : detail impl ] ;

#-------------------------------------------------------------------------------
#
# Generate transform.xsl. This xsl transfomration takes as input
# the Doxygen-generated XML and produces QuickBook output.
#
make transform.xsl
    :
        docca/include/docca/doxygen.xsl
    :
        @make_transform
    :
        <dependency>xsl/config.xsl
        <dependency>xsl/class_detail.xsl
        <dependency>xsl/includes.xsl
        <dependency>xsl/includes_foot.xsl
    ;

# Make a copy of the docca transform. Then, insert our
# customizations into the speciall marked locations using sed.
#
actions make_transform
{
    cp $(2) $(1)
    sed -i -e "/<!-- CONFIG_TEMPLATE -->/{r xsl/config.xsl" -e "d}" $(1)
    sed -i -e "/<!-- CLASS_DETAIL_TEMPLATE -->/{r xsl/class_detail.xsl" -e "d}" $(1)
    sed -i -e "/<!-- INCLUDES_TEMPLATE -->/{r xsl/includes.xsl" -e "d}" $(1)
    sed -i -e "/<!-- INCLUDES_FOOT_TEMPLATE -->/{r xsl/includes_foot.xsl" -e "d}" $(1)
}

#-------------------------------------------------------------------------------
#
# Invoke Doxygen to process the header files and produce the XML
# containing the description of the C++ declarations and extracted
# Javadoc comments.
#
make reference.xml
    :
        ./source.dox
    :
        @make_xml
    :
        <dependency>$(sources)
    ;

# Windows is a little different from other platforms
if [ os.name ] = NT
{
    actions make_xml
    {
        SET LIB_DIR=$(2:B=:S=..)
        SET XML_OUTPUT=$(1:D)
        doxygen $(2) && xsltproc $(1:B=combine:S=.xslt) $(1:B=index:S=.xml) > $(1)
    }
}
else
{
    actions make_xml
    {
        export LIB_DIR=$(2:D)
        export XML_OUTPUT=$(1:D)
        doxygen $(2) && xsltproc $(1:B=combine:S=.xslt) $(1:B=index:S=.xml) > $(1)
    }
}

#-------------------------------------------------------------------------------
#
# Produce the reference.qbk file by running
# the reference xml through the transform.
#
make reference.qbk
    :
        transform.xsl
        reference.xml
    :
        @make_reference
    ;

actions make_reference
{
    xsltproc $(2) $(3) > $(1)
}

# We have to make a copy of reference.qbk and put it
# in a place where the static .qbk files can find it
#
install qbk : reference.qbk ;

#-------------------------------------------------------------------------------
#
# Produce the Boost.Book XML from the QuickBook
#
xml beast_doc
    :
        qbk/00_main.qbk
    :
        <implicit-dependency>reference.qbk
    ;

explicit beast_doc ;

install images
    :
        images/message.png
    :
        <location>html/beast/images
    ;

explicit images ;

#-------------------------------------------------------------------------------
#
# HTML documentation for $(BOOST_ROOT)/doc/html
#
#-------------------------------------------------------------------------------

boostbook beast
    :
        beast_doc
    :
        <xsl:param>boost.root=../../../..
        <xsl:param>root.filename=beast
        <xsl:param>chapter.autolabel=1
        <xsl:param>chunk.section.depth=8                # Depth to which sections should be chunked
        <xsl:param>chunk.first.sections=1               # Chunk the first top-level section?
        <xsl:param>toc.section.depth=8                  # How deep should recursive sections appear in the TOC?
        <xsl:param>toc.max.depth=8                      # How many levels should be created for each TOC?
        <xsl:param>generate.section.toc.level=8         # Control depth of TOC generation in sections
        <xsl:param>generate.toc="chapter toc,title section nop reference nop"
        <include>../../../tools/boostbook/dtd
    :
        <dependency>images
    ;


#-------------------------------------------------------------------------------
#
# These are used to inform the build system of the
# means to build the integrated and stand-alone docs.
#

alias boostdoc : beast : : : ;

explicit boostdoc ;

alias boostrelease ;

explicit boostrelease ;
